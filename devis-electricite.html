<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Devis √©lectricit√© ‚Äì DS.BAT</title>
    <meta name="description" content="Simulateur de devis √©lectricit√© avec deux gammes (Mosaic / Saillie) et estimation automatique selon norme NF C 15-100.">

    <!-- Google Fonts Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- html2pdf (chargement diff√©r√©) -->
    <script>
        window.loadPDF = function(callback) {
            if (window.html2pdf) {
                callback();
            } else {
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js';
                script.onload = callback;
                document.head.appendChild(script);
            }
        };
    </script>

    <style>
        /* ---------- VARIABLES CLAIR/SOMBRE ---------- */
        :root { color-scheme: light dark; 
          --bg: #f1f5f9; --surface: white; --surface-2: #f8fafc;
          --text: #0f172a; --text-light: #334155;
          --primary: #1e3a8a; --primary-light: #3b82f6; --primary-dark: #0f2b5e;
          --secondary: #c59d5f; --accent: #16a34a; --border: #e2e8f0;
          --shadow: 0 6px 18px rgba(0,0,0,0.04); --shadow-hover: 0 16px 28px rgba(0,0,0,0.08);
          --radius-md: 24px; --radius-lg: 32px; --transition: 0.2s ease;
        }
        @media (prefers-color-scheme: dark) { :root { 
          --bg: #0b1120; --surface: #1e293b; --surface-2: #2d3a4f;
          --text: #f1f5f9; --text-light: #cbd5e1; --border: #334155;
          --shadow: 0 6px 18px rgba(0,0,0,0.5); --shadow-hover: 0 16px 28px rgba(0,0,0,0.7);
        } }

        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; display: flex; flex-direction: column; }
        main { flex:1; }
        a { color:inherit; text-decoration:none; }
        a:focus-visible { outline: 4px solid var(--secondary); outline-offset: 4px; border-radius: 4px; }

        /* ---------- MENU ---------- */
        .menu-btn {
            position:fixed; top:18px; right:18px; font-size:26px;
            background:var(--primary); color:white; border:none;
            padding:10px 14px; border-radius:12px; cursor:pointer; z-index:1001;
            box-shadow:var(--shadow); transition:var(--transition);
        }
        .menu-btn:hover { background:var(--primary-light); transform:scale(0.98); }
        .menu {
            position:fixed; top:0; right:-300px; width:280px; height:100%;
            background:#0f172a; padding-top:80px; transition:right .4s;
            z-index:1000; box-shadow:-8px 0 30px rgba(0,0,0,0.3);
        }
        .menu.open { right:0; }
        .menu a {
            display:block; padding:18px 24px; color:white;
            border-bottom:1px solid rgba(255,255,255,.08); font-weight:500;
        }
        .menu a:hover { background:var(--primary); padding-left:32px; }

        /* ---------- HERO ---------- */
        .hero {
            height:25vh; min-height:180px;
            background: linear-gradient(135deg, rgba(10,20,40,.9), rgba(10,20,40,.6)),
                        url("image/chantier-verriere.jpg") center 30% / cover no-repeat;
            display:flex; flex-direction:column; justify-content:center; align-items:center;
            text-align:center; color:white; padding:20px;
        }
        .hero h1 { font-size:2rem; font-weight:700; margin-bottom:8px; }
        .hero p { font-size:0.95rem; opacity:0.9; background:rgba(0,0,0,0.2); padding:6px 20px; border-radius:60px; }

        /* ---------- CONTENEUR ---------- */
        .container {
            max-width: 1400px; margin: 30px auto; background: var(--surface);
            padding: 30px; border-radius: var(--radius-lg); box-shadow: var(--shadow-hover);
        }

        /* ---------- EN-T√äTE DEVIS ---------- */
        .devis-header {
            display: flex; justify-content: space-between; align-items: center;
            flex-wrap: wrap; margin-bottom: 30px; padding-bottom: 20px;
            border-bottom: 2px dashed var(--border);
        }
        .devis-numero {
            background: var(--primary); color: white; padding: 8px 20px;
            border-radius: 60px; font-weight: 700;
        }
        .devis-date { color: var(--text-light); font-weight: 500; }

        /* ---------- R√âCAPITULATIF CHANTIER ---------- */
        .recap-chantier {
            background: var(--surface-2); padding: 20px; border-radius: var(--radius-md);
            margin-bottom: 30px; border: 1px solid var(--border);
        }
        .recap-chantier h4 {
            display: flex; align-items: center; gap: 10px;
            color: var(--primary); margin-bottom: 15px;
        }
        .grille-recap {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px,1fr));
            gap: 10px;
        }
        .btn-modifier {
            background: var(--primary); color: white; padding: 8px 16px;
            border-radius: 60px; font-size: 0.9rem; display: inline-block;
            margin-top: 15px; text-align: right;
        }

        /* ---------- S√âLECTEUR DE GAMME ---------- */
        .options-globales {
            display: flex; gap: 30px; flex-wrap: wrap; align-items: center;
            margin-bottom: 30px; background: var(--surface-2); padding: 20px; border-radius: var(--radius-md);
        }
        .radio-group {
            display: flex; align-items: center; gap: 20px; flex-wrap: wrap;
        }
        .radio-group label {
            display: flex; align-items: center; gap: 8px; cursor: pointer;
            background: var(--surface); padding: 10px 20px; border-radius: 60px;
            border: 1px solid var(--border); font-weight: 500;
        }
        .radio-group input[type=radio] { accent-color: var(--primary); width: 18px; height: 18px; }
        .btn-norme {
            background: var(--primary); color: white; padding: 10px 25px;
            border-radius: 60px; font-weight: 600; border: none; cursor: pointer;
            transition: var(--transition); margin-left: auto;
        }
        .btn-norme:hover { background: var(--primary-light); transform: translateY(-2px); }

        /* ---------- GRILLE PRESTATIONS ---------- */
        .prestations-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px; margin-top: 20px;
        }
        .prestation-item {
            background: var(--surface-2); padding: 20px; border-radius: var(--radius-md);
            border: 1px solid var(--border); transition: var(--transition);
        }
        .prestation-item:hover { border-color: var(--primary-light); box-shadow: var(--shadow); }
        .prestation-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; font-weight: 600;
        }
        .prestation-prix {
            background: var(--primary); color: white; padding: 4px 12px;
            border-radius: 30px; font-size: 0.9rem;
        }
        .quantite-input {
            display: flex; align-items: center; gap: 10px;
        }
        .quantite-input input {
            width: 80px; padding: 10px; border-radius: 30px; border: 1px solid var(--border);
            background: var(--surface); color: var(--text); font-size: 1rem;
        }

        /* ---------- R√âCAPITULATIF ---------- */
        .recap {
            margin-top: 40px; background: var(--surface-2); padding: 30px;
            border-radius: var(--radius-lg); border: 2px solid var(--primary);
        }
        .recap-ligne {
            display: flex; justify-content: space-between; align-items: center;
            flex-wrap: wrap; margin-bottom: 15px; padding-bottom: 10px;
            border-bottom: 1px dashed var(--border);
        }
        .recap-ligne:last-of-type {
            border-bottom: none;
        }
        .total-wrapper {
            display: flex; justify-content: center; align-items: baseline; gap: 15px;
            margin: 20px 0;
        }
        .total {
            font-size: 3rem; font-weight: 800; color: var(--accent);
        }
        .acomptes {
            display: flex; flex-wrap: wrap; justify-content: center; gap: 15px;
            margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border);
        }
        .acompte-badge {
            background: var(--surface); padding: 10px 20px; border-radius: 60px;
            border: 1px solid var(--border); font-weight: 600;
        }

        /* ---------- BOUTONS ---------- */
        .actions {
            display: flex; flex-wrap: wrap; gap: 15px; justify-content: center;
            margin-top: 30px;
        }
        .btn {
            padding: 14px 28px; border-radius: 60px; font-weight: 600; border: none;
            cursor: pointer; transition: var(--transition); display: inline-flex;
            align-items: center; gap: 8px; font-size: 1rem;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-light); transform: translateY(-2px); }
        .btn-pdf { background: #ef4444; color: white; }
        .btn-whatsapp { background: #25D366; color: white; }
        .btn-phone { background: var(--secondary); color: #0f172a; }

        /* ---------- BADGES ---------- */
        .badges {
            display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;
            margin-top: 40px; padding: 15px; background: var(--surface-2);
            border-radius: 60px;
        }
        .badge {
            background: var(--primary-dark); color: white; padding: 8px 18px;
            border-radius: 40px; font-size: 0.85rem; font-weight: 500;
        }

        /* ---------- FOOTER ---------- */
        footer {
            background: #020617; color: #cbd5e1; text-align: center;
            padding: 25px; margin-top: 20px;
        }
        footer a { color: #c59d5f; border-bottom: 1px solid transparent; }
        footer a:hover { border-bottom-color: #c59d5f; }

        /* ---------- WHATSAPP FLOTTANT ---------- */
        .whatsapp-float {
            position:fixed; width:64px; height:64px; bottom:24px; right:24px;
            background:#25D366; border-radius:50%; display:flex; justify-content:center;
            align-items:center; z-index:1002; box-shadow:0 8px 20px rgba(0,0,0,0.3);
            transition:transform 0.25s;
        }
        .whatsapp-float:hover { transform:scale(1.12); }
        .whatsapp-float img { width:36px; height:36px; }

        @media (max-width:700px) {
            .hero h1 { font-size:1.6rem; }
            .total { font-size:2.2rem; }
            .options-globales { flex-direction: column; align-items: stretch; }
            .btn-norme { margin-left: 0; width: 100%; }
        }
    </style>
</head>
<body>

<!-- ---------- MENU CORRIG√â ---------- -->
<button class="menu-btn" id="menuBtn" aria-label="Ouvrir le menu" aria-expanded="false" aria-controls="menu">‚ò∞</button>
<nav class="menu" id="menu" aria-hidden="true">
    <a href="index.html">üè† Accueil</a>
    <a href="services.html">‚öôÔ∏è Services</a>
    <a href="realisations.html">üì∑ R√©alisations</a>
    <a href="zone.html">üìç Zone</a>
    <a href="prix.html">üí∞ Prix</a>
    <a href="devis.html">‚ö° Devis interactif</a>
    <a href="contact.html">üìû Contact</a>
    <a href="avis-client.html">‚≠ê Avis</a>
    <a href="faq.html">‚ùì FAQ</a>
    <a href="https://www.instagram.com/votrecompte" target="_blank">üì∏ Instagram</a>
    <a href="https://www.facebook.com/votrecompte" target="_blank">üëç Facebook</a>
</nav>

<!-- HERO -->
<header class="hero">
    <h1>‚ö° Devis √©lectricit√©</h1>
    <p>Personnalisez votre installation √©lectrique ‚Äì Estimation selon NF C 15-100</p>
</header>

<main class="container" id="contenuDevis">

    <!-- EN-T√äTE DU DEVIS -->
    <div class="devis-header">
        <span class="devis-numero" id="devisNumero">ELEC‚Äë2026‚Äë1001</span>
        <span class="devis-date" id="devisDate"></span>
    </div>

    <!-- R√âCAPITULATIF DU CHANTIER -->
    <div class="recap-chantier">
        <h4>üìã Chantier enregistr√©</h4>
        <div class="grille-recap">
            <div><strong>Type de bien :</strong> <span id="recapTypeBien"></span></div>
            <div><strong>Type logement :</strong> <span id="recapTypeLogement"></span></div>
            <div><strong>Surface :</strong> <span id="recapSurface"></span> m¬≤</div>
            <div><strong>Pi√®ces :</strong> <span id="recapPieces"></span></div>
            <div><strong>Accessibilit√© :</strong> <span id="recapAccessibilite"></span></div>
            <div><strong>√Çge du b√¢timent :</strong> <span id="recapAge"></span></div>
            <div id="recapEtageCont" style="display:none;"><strong>√âtage :</strong> <span id="recapEtage"></span></div>
            <div id="recapAscenseurCont" style="display:none;"><strong>Ascenseur :</strong> <span id="recapAscenseur"></span></div>
            <div><strong>Hauteur plafond :</strong> <span id="recapHauteur"></span></div>
            <div><strong>Type compteur :</strong> <span id="recapCompteur"></span></div>
            <div><strong>Puissance :</strong> <span id="recapPuissance"></span></div>
        </div>
        <div style="text-align:right; margin-top:15px;">
            <a href="devis.html" class="btn-modifier">‚úèÔ∏è Modifier le chantier</a>
        </div>
    </div>

    <!-- CHOIX DE LA GAMME + BOUTON NORME -->
    <div class="options-globales">
        <div class="radio-group">
            <label>
                <input type="radio" name="gamme" value="mosaic" checked onchange="changerGamme()"> üü¶ Mosaic (neuf, TVA 20%)
            </label>
            <label>
                <input type="radio" name="gamme" value="saillie" onchange="changerGamme()"> üü® Legrand Saillie (r√©novation, TVA 10%)
            </label>
        </div>
        <button class="btn-norme" onclick="appliquerNorme()">üìê Appliquer les minimas NF C 15-100</button>
    </div>

    <!-- LISTE DES PRESTATIONS -->
    <div id="prestations-container" class="prestations-grid"></div>

    <!-- R√âCAPITULATIF D√âTAILL√â -->
    <div class="recap">
        <div class="recap-ligne">
            <span>Total des prestations (hors tableau et VDI)</span>
            <span id="totalPrestationsHorsEquip" style="font-weight:700;">0 ‚Ç¨</span>
        </div>
        <div class="recap-ligne">
            <span>üìä Tableau √©lectrique (adapt√© au logement)</span>
            <span id="prixTableau" style="font-weight:700;">0 ‚Ç¨</span>
        </div>
        <div class="recap-ligne">
            <span>üñß Coffret VDI (selon nombre de RJ45)</span>
            <span id="prixCoffret" style="font-weight:700;">0 ‚Ç¨</span>
        </div>
        <div class="recap-ligne">
            <span>‚ö° Liaison √©quipotentielle + prise de terre</span>
            <span id="prixTerre" style="font-weight:700;">0 ‚Ç¨</span>
        </div>
        <div class="recap-ligne">
            <span>üöê Suppl√©ments (accessibilit√©, √©tage...)</span>
            <span id="supplementsMontant" style="font-weight:700;">0 ‚Ç¨</span>
        </div>
        <div class="total-wrapper">
            <span class="total" id="totalHT">0 ‚Ç¨</span>
            <span style="font-size:1.2rem;">HT</span>
        </div>
        <div style="display:flex; justify-content:space-between; flex-wrap:wrap; margin-top:15px;">
            <span><strong>TVA</strong> <span id="tvaMontant">0 ‚Ç¨</span></span>
            <span><strong>Total TTC</strong> <span id="totalTTC">0 ‚Ç¨</span></span>
        </div>
        <div class="acomptes">
            <span class="acompte-badge" id="acompte1">40% : 0 ‚Ç¨</span>
            <span class="acompte-badge" id="acompte2">30% : 0 ‚Ç¨</span>
            <span class="acompte-badge" id="acompte3">30% : 0 ‚Ç¨</span>
        </div>
    </div>

    <!-- BOUTONS D'ACTION -->
    <div class="actions">
        <button class="btn btn-pdf" onclick="genererPDF()">üìÑ T√©l√©charger PDF</button>
        <button class="btn btn-whatsapp" onclick="envoyerWhatsApp()">üí¨ Envoyer sur WhatsApp</button>
        <a class="btn btn-phone" href="#" data-phone-base64="MDYyOTU1NjYyNw==">üìû 06<!-- -->29<!-- -->55<!-- -->66<!-- -->27</a>
    </div>

    <!-- BADGES DE CONFIANCE -->
    <div class="badges">
        <span class="badge">‚úîÔ∏è Artisan certifi√©</span>
        <span class="badge">‚úîÔ∏è Assurance d√©cennale</span>
        <span class="badge">‚úîÔ∏è Devis gratuit</span>
        <span class="badge">‚úîÔ∏è Garantie 2 ans</span>
        <span class="badge">‚≠ê 4,9/5 ‚Äì 12 avis</span>
    </div>
</main>

<!-- WHATSAPP FLOTTANT -->
<a href="https://wa.me/33629556627" target="_blank" rel="noopener noreferrer" class="whatsapp-float" aria-label="Contact WhatsApp">
    <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WhatsApp">
</a>

<footer>
    <p>¬© 2026 DS.BAT ‚Äì 58 Grande Rue, 77410 Villevaud√© | <a href="mentions-legales.html">Mentions l√©gales</a></p>
    <p style="margin-top:12px;">Simulateur √©lectricit√© ‚Äì Gammes Mosaic / Saillie ‚Äì D√©tail tableau et VDI inclus ‚Äì NF C 15-100</p>
</footer>

<script>
    // ---------- 1. R√âCUP√âRATION DES DONN√âES DU CHANTIER ----------
    let chantier = null;
    try {
        const stored = sessionStorage.getItem('chantier');
        if (stored) {
            chantier = JSON.parse(stored);
        } else {
            window.location.href = 'devis.html';
        }
    } catch (e) {
        window.location.href = 'devis.html';
    }

    // Mise √† jour du r√©capitulatif
    function mettreAJourRecap() {
        document.getElementById('recapTypeBien').innerText = chantier.typeBien === 'maison' ? 'Maison' : 'Appartement';
        document.getElementById('recapTypeLogement').innerText = chantier.typeLogement;
        document.getElementById('recapSurface').innerText = chantier.surface;
        document.getElementById('recapPieces').innerText = chantier.pieces;
        document.getElementById('recapAccessibilite').innerText = chantier.accessibilite === 'facile' ? 'Facile' : 'Compliqu√©e';
        document.getElementById('recapAge').innerText = chantier.ageBati === 'plus2' ? 'Plus de 2 ans' : 'Moins de 2 ans';
        document.getElementById('recapHauteur').innerText = {
            standard: 'Standard (<2,5m)',
            haute: 'Haute (2,5-3m)',
            tres_haute: 'Tr√®s haute (>3m)'
        }[chantier.hauteurPlafond] || chantier.hauteurPlafond;
        document.getElementById('recapCompteur').innerText = chantier.compteurType === 'mono' ? 'Monophas√©' : 'Triphas√©';
        document.getElementById('recapPuissance').innerText = chantier.compteurPuissance + ' kVA';

        if (chantier.typeBien === 'appartement') {
            document.getElementById('recapEtageCont').style.display = 'block';
            document.getElementById('recapEtage').innerText = chantier.etage;
            document.getElementById('recapAscenseurCont').style.display = 'block';
            document.getElementById('recapAscenseur').innerText = chantier.ascenseur === 'oui' ? 'Oui' : 'Non';
        } else {
            document.getElementById('recapEtageCont').style.display = 'none';
            document.getElementById('recapAscenseurCont').style.display = 'none';
        }
    }
    mettreAJourRecap();

    // ---------- 2. LISTE DES PRESTATIONS ----------
    const prestations = [
        // Points lumineux
        { label: "Point lumineux simple allumage", unite: "u", mosaic: 89.20, saillie: 207.80 },
        { label: "Point lumineux va-et-vient", unite: "u", mosaic: 131.69, saillie: 314.81 },
        { label: "Point lumineux sur t√©l√©rupteur (3 BP)", unite: "u", mosaic: 196.76, saillie: 438.26 },
        { label: "Point lumineux avec variateur", unite: "u", mosaic: 0, saillie: 263.75 },
        { label: "Point lumineux avec interrupteur automatique", unite: "u", mosaic: 197.18, saillie: 342.20 },
        { label: "Point lumineux suppl√©mentaire (plafond)", unite: "u", mosaic: 42.92, saillie: 125.25 },
        { label: "Point lumineux suppl√©mentaire (applique)", unite: "u", mosaic: 42.23, saillie: 77.56 },
        { label: "Double allumage (2 points)", unite: "u", mosaic: 147.06, saillie: 325.22 },
        { label: "Double allumage (plafond + applique)", unite: "u", mosaic: 129.36, saillie: 294.43 },
        { label: "Point lumineux avec t√©moin", unite: "u", mosaic: 90.70, saillie: 235.69 },
        { label: "Point lumineux lumineux", unite: "u", mosaic: 90.70, saillie: 235.69 },
        { label: "Bouton poussoir suppl√©mentaire", unite: "u", mosaic: 53.85, saillie: 83.39 },
        // Prises
        { label: "Prise 2P+T", unite: "u", mosaic: 83.97, saillie: 125.98 },
        { label: "Prise sp√©cialis√©e 20A", unite: "u", mosaic: 108.92, saillie: 152.58 },
        { label: "Prise sp√©cialis√©e 32A", unite: "u", mosaic: 150.98, saillie: 196.23 },
        { label: "Prise double 2P+T", unite: "u", mosaic: 113.40, saillie: 167.46 },
        { label: "Prise triple 2P+T", unite: "u", mosaic: 141.44, saillie: 199.82 },
        { label: "Prise command√©e", unite: "u", mosaic: 99.73, saillie: 203.31 },
        { label: "Prise TV", unite: "u", mosaic: 87.05, saillie: 152.68 },
        { label: "Prise TV/FM/SAT", unite: "u", mosaic: 120.78, saillie: 183.45 },
        { label: "Prise RJ45 Cat6 FTP", unite: "u", mosaic: 97.65, saillie: 170.65 },
        { label: "Prise haut-parleurs", unite: "u", mosaic: 115.75, saillie: 125.02 },
        { label: "Prise 2P+T + RJ45", unite: "u", mosaic: 185.91, saillie: 250.65 },
        { label: "Prise double 2P+T + TV/FM/SAT", unite: "u", mosaic: 226.70, saillie: 266.01 },
        { label: "Prise double 2P+T + RJ45", unite: "u", mosaic: 223.37, saillie: 273.01 },
        { label: "Prise t√©l√©phone en T", unite: "u", mosaic: 85.65, saillie: 175.93 },
        { label: "Prise 2P+T + t√©l√©phone", unite: "u", mosaic: 156.19, saillie: 212.41 },
        // Commandes
        { label: "Commande volets roulants", unite: "u", mosaic: 119.64, saillie: 179.09 },
        { label: "Commande VMC", unite: "u", mosaic: 89.68, saillie: 147.75 },
        { label: "Bouton poussoir sonnette IP44", unite: "u", mosaic: 88.41, saillie: 162.28 },
        { label: "Thermostat", unite: "u", mosaic: 289.81, saillie: 218.71 },
        // Sorties de c√¢ble
        { label: "Sortie de c√¢ble 10A", unite: "u", mosaic: 82.93, saillie: 141.15 },
        { label: "Sortie de c√¢ble 10A fil pilote", unite: "u", mosaic: 87.06, saillie: 143.85 },
        { label: "Sortie de c√¢ble 20A", unite: "u", mosaic: 90.06, saillie: 146.25 },
        { label: "Sortie de c√¢ble 20A fil pilote", unite: "u", mosaic: 93.06, saillie: 148.95 },
        { label: "Sortie de c√¢ble 32A", unite: "u", mosaic: 146.26, saillie: 175.35 }
    ];

    // ---------- 3. TABLEAUX √âLECTRIQUES (par type de logement) ----------
    const tableaux = {
        T1: { mosaic: 1354.23, saillie: 1354.23 },
        T2: { mosaic: 1348.64, saillie: 1348.64 },
        T3: { mosaic: 2584.37, saillie: 2584.37 },
        T4: { mosaic: 2089.61, saillie: 2089.61 },
        T5: { mosaic: 402.72, saillie: 402.72 },
        T6: { mosaic: 617.81, saillie: 617.81 }
    };

    // ---------- 4. COFFRETS DE COMMUNICATION (selon nombre de RJ45) ----------
    const coffrets = [
        { seuil: 4, mosaic: 268.53, saillie: 268.53 },
        { seuil: 6, mosaic: 402.72, saillie: 402.72 },
        { seuil: 8, mosaic: 528.47, saillie: 528.47 },
        { seuil: 12, mosaic: 617.81, saillie: 617.81 }
    ];

    // ---------- 5. G√âN√âRATION DE L'INTERFACE ----------
    function genererPrestations() {
        const container = document.getElementById('prestations-container');
        container.innerHTML = '';
        prestations.forEach(p => {
            const div = document.createElement('div');
            div.className = 'prestation-item';
            // Cr√©er un ID unique bas√© sur le libell√© (sans espaces ni caract√®res sp√©ciaux)
            const id = p.label.replace(/\s/g,'').replace(/[^a-zA-Z0-9]/g,'');
            div.innerHTML = `
                <div class="prestation-header">
                    <span>${p.label} (${p.unite})</span>
                    <span class="prestation-prix" id="prix-${id}">${p.mosaic} ‚Ç¨</span>
                </div>
                <div class="quantite-input">
                    <label>Quantit√© :</label>
                    <input type="number" id="qte-${id}" min="0" value="0" step="1" onchange="calculer()">
                </div>
            `;
            container.appendChild(div);
        });
    }

    // ---------- 6. ESTIMATION DES MINIMAS SELON NORME NF C 15-100 ----------
    function estimerMinimas() {
        const surface = parseFloat(chantier.surface) || 70;
        const pieces = parseInt(chantier.pieces) || 4;
        const typeLog = chantier.typeLogement; // T1, T2, etc.
        // Estimation du nombre de chambres (approximatif)
        let nbChambres = 0;
        if (typeLog === 'T1') nbChambres = 0;
        else if (typeLog === 'T2') nbChambres = 1;
        else if (typeLog === 'T3') nbChambres = 2;
        else if (typeLog === 'T4') nbChambres = 3;
        else if (typeLog === 'T5') nbChambres = 4;
        else if (typeLog === 'T6') nbChambres = 5;
        else nbChambres = Math.floor(pieces / 2); // fallback

        // R√®gles simples (modifiables selon vos pratiques)
        return {
            prise2PpT: Math.max(5, Math.ceil(surface / 5)),
            pointLumineuxSimple: Math.ceil(pieces * 1.5),
            pointLumineuxVaEtVient: Math.max(1, Math.ceil(surface / 20)),
            priseTV: 1 + nbChambres,
            priseRJ45: 1 + nbChambres,
            prise20A: 2,
            prise32A: 1,
            commandeVolets: 0,
            commandeVMC: 1,
            thermostat: 1,
            sortie10A: 2,
            sortie20A: 1,
        };
    }

    // ---------- 7. APPLICATION DES MINIMAS DANS LES CHAMPS ----------
    function appliquerNorme() {
        const minimas = estimerMinimas();
        // Correspondance entre motifs de libell√© et cl√©s de minimas
        const correspondances = [
            { pattern: /Prise 2P\+T$/i, key: 'prise2PpT' },
            { pattern: /Point lumineux simple allumage/i, key: 'pointLumineuxSimple' },
            { pattern: /Point lumineux va-et-vient/i, key: 'pointLumineuxVaEtVient' },
            { pattern: /Prise TV$/i, key: 'priseTV' },
            { pattern: /Prise RJ45 Cat6 FTP/i, key: 'priseRJ45' },
            { pattern: /Prise sp√©cialis√©e 20A/i, key: 'prise20A' },
            { pattern: /Prise sp√©cialis√©e 32A/i, key: 'prise32A' },
            { pattern: /Commande volets/i, key: 'commandeVolets' },
            { pattern: /Commande VMC/i, key: 'commandeVMC' },
            { pattern: /Thermostat/i, key: 'thermostat' },
            { pattern: /Sortie de c√¢ble 10A$/i, key: 'sortie10A' },
            { pattern: /Sortie de c√¢ble 20A$/i, key: 'sortie20A' },
        ];

        prestations.forEach(p => {
            const id = p.label.replace(/\s/g,'').replace(/[^a-zA-Z0-9]/g,'');
            const input = document.getElementById(`qte-${id}`);
            if (!input) return;
            for (let c of correspondances) {
                if (c.pattern.test(p.label)) {
                    const val = minimas[c.key] || 0;
                    input.value = val;
                    break;
                }
            }
        });
        calculer();
    }

    // ---------- 8. CHANGEMENT DE GAMME ----------
    function changerGamme() {
        const gamme = document.querySelector('input[name="gamme"]:checked').value;
        prestations.forEach(p => {
            const id = p.label.replace(/\s/g,'').replace(/[^a-zA-Z0-9]/g,'');
            const prix = (gamme === 'mosaic') ? p.mosaic : p.saillie;
            const span = document.getElementById(`prix-${id}`);
            if (span) span.innerText = prix + ' ‚Ç¨';
        });
        calculer();
    }

    // ---------- 9. CALCUL DU TOTAL ----------
    function calculer() {
        const gamme = document.querySelector('input[name="gamme"]:checked').value;
        let totalPrestations = 0;

        // Somme des prestations
        prestations.forEach(p => {
            const id = p.label.replace(/\s/g,'').replace(/[^a-zA-Z0-9]/g,'');
            const qte = parseFloat(document.getElementById(`qte-${id}`)?.value) || 0;
            const prixUnitaire = (gamme === 'mosaic') ? p.mosaic : p.saillie;
            totalPrestations += qte * prixUnitaire;
        });

        // Tableau √©lectrique (selon type de logement)
        const typeLog = chantier.typeLogement;
        const prixTableau = tableaux[typeLog]?.[gamme] || 0;
        document.getElementById('prixTableau').innerText = prixTableau.toFixed(2) + ' ‚Ç¨';

        // Coffret VDI (selon nombre de prises RJ45)
        const rj45Id = 'qte-PriseRJ45Cat6FTP'; // ID de la prestation RJ45
        const qteRJ45 = parseFloat(document.getElementById(rj45Id)?.value) || 0;
        let prixCoffret = 0;
        for (let c of coffrets) {
            if (qteRJ45 <= c.seuil) {
                prixCoffret = c[gamme];
                break;
            }
        }
        if (qteRJ45 > 8) prixCoffret = coffrets[coffrets.length-1][gamme];
        document.getElementById('prixCoffret').innerText = prixCoffret.toFixed(2) + ' ‚Ç¨';

        // Liaison √©quipotentielle + prise de terre (m√™mes prix pour les deux gammes)
        const prixTerre = 93.03 + 188.07;
        document.getElementById('prixTerre').innerText = prixTerre.toFixed(2) + ' ‚Ç¨';

        // Sous-total hors suppl√©ments
        let sousTotal = totalPrestations + prixTableau + prixCoffret + prixTerre;

        // --- Calcul des suppl√©ments bas√©s sur le chantier ---
        let supplement = 0;

        // Accessibilit√© compliqu√©e : majoration de 15% sur la main d'≈ìuvre (estim√©e √† 60% du total prestations)
        if (chantier.accessibilite === 'compliquee') {
            supplement += totalPrestations * 0.6 * 0.15;
        }

        // Appartement sans ascenseur : suppl√©ment par √©tage (50 ‚Ç¨ par √©tage)
        if (chantier.typeBien === 'appartement' && chantier.ascenseur === 'non') {
            const etage = parseInt(chantier.etage) || 0;
            if (etage > 0) supplement += etage * 50;
        }

        // Hauteur sous plafond : si haute ou tr√®s haute, majoration forfaitaire
        if (chantier.hauteurPlafond === 'haute') {
            supplement += 200;
        } else if (chantier.hauteurPlafond === 'tres_haute') {
            supplement += 400;
        }

        // D√©lai rapide ou urgent
        if (chantier.delai === 'rapide') {
            supplement += sousTotal * 0.20;
        } else if (chantier.delai === 'urgent') {
            supplement += sousTotal * 0.40;
        }

        document.getElementById('supplementsMontant').innerText = supplement.toFixed(2) + ' ‚Ç¨';

        // Total HT
        let totalHT = sousTotal + supplement;
        totalHT = Math.round(totalHT * 100) / 100;
        document.getElementById('totalPrestationsHorsEquip').innerText = totalPrestations.toFixed(2) + ' ‚Ç¨';
        document.getElementById('totalHT').innerText = totalHT.toLocaleString('fr-FR', { minimumFractionDigits: 2 }) + ' ‚Ç¨';

        // TVA
        let tauxTVA = 0.20; // par d√©faut (Mosaic)
        if (gamme === 'saillie') {
            // Si r√©novation, TVA 10% si le b√¢timent a plus de 2 ans
            tauxTVA = (chantier.ageBati === 'plus2') ? 0.10 : 0.20;
        }
        const montantTVA = totalHT * tauxTVA;
        const totalTTC = totalHT + montantTVA;
        document.getElementById('tvaMontant').innerText = montantTVA.toLocaleString('fr-FR', { minimumFractionDigits: 2 }) + ' ‚Ç¨';
        document.getElementById('totalTTC').innerText = totalTTC.toLocaleString('fr-FR', { minimumFractionDigits: 2 }) + ' ‚Ç¨';

        // Acomptes 40/30/30
        const acompte1 = totalTTC * 0.4;
        const acompte2 = totalTTC * 0.3;
        const acompte3 = totalTTC * 0.3;
        document.getElementById('acompte1').innerText = `40% : ${acompte1.toLocaleString('fr-FR', { minimumFractionDigits: 2 })} ‚Ç¨`;
        document.getElementById('acompte2').innerText = `30% : ${acompte2.toLocaleString('fr-FR', { minimumFractionDigits: 2 })} ‚Ç¨`;
        document.getElementById('acompte3').innerText = `30% : ${acompte3.toLocaleString('fr-FR', { minimumFractionDigits: 2 })} ‚Ç¨`;

        window.totalHT = totalHT;
        window.totalTTC = totalTTC;
    }

    // ---------- 10. NUM√âRO DE DEVIS & DATE ----------
    function genererNumeroDevis() {
        let compteur = localStorage.getItem('dsbat-devis-compteur') || 1000;
        compteur = parseInt(compteur) + 1;
        localStorage.setItem('dsbat-devis-compteur', compteur);
        return `ELEC‚Äë2026‚Äë${compteur}`;
    }

    function afficherDate() {
        const d = new Date();
        document.getElementById('devisDate').innerText = d.toLocaleDateString('fr-FR', { day:'2-digit', month:'2-digit', year:'numeric' });
    }

    // ---------- 11. PDF & WHATSAPP ----------
    function genererPDF() {
        window.loadPDF(() => {
            const element = document.getElementById('contenuDevis');
            const numero = document.getElementById('devisNumero').innerText.replace(/[^0-9]/g,'');
            html2pdf().from(element).set({
                margin: 15,
                filename: `devis_elec_${numero}.pdf`,
                image: { type: 'jpeg', quality: 0.95 },
                html2canvas: { scale: 2, letterRendering: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            }).save();
        });
    }

    function envoyerWhatsApp() {
        const totalTTC = document.getElementById('totalTTC').innerText;
        const message = `*Devis √©lectricit√© DS.BAT*%0A%0ATotal TTC : ${totalTTC}%0A%0APouvez-vous me rappeler ?`;
        window.open(`https://wa.me/33629556627?text=${encodeURIComponent(message)}`);
    }

    // ---------- 12. PROTECTION NUM√âRO T√âL√âPHONE ----------
    document.querySelectorAll('[data-phone-base64]').forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const phone = atob(link.dataset.phoneBase64);
            window.location.href = `tel:${phone}`;
        });
    });

    // ---------- 13. MENU TOGGLE ----------
    const menu = document.getElementById('menu');
    const btn = document.getElementById('menuBtn');
    btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const isOpen = menu.classList.toggle('open');
        btn.setAttribute('aria-expanded', isOpen);
        menu.setAttribute('aria-hidden', !isOpen);
    });
    document.addEventListener('click', (e) => {
        if (!menu.contains(e.target) && !btn.contains(e.target)) {
            menu.classList.remove('open');
            btn.setAttribute('aria-expanded', 'false');
            menu.setAttribute('aria-hidden', 'true');
        }
    });
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            menu.classList.remove('open');
            btn.setAttribute('aria-expanded', 'false');
            menu.setAttribute('aria-hidden', 'true');
            btn.focus();
        }
    });
    document.querySelectorAll('.menu a').forEach(link => {
        link.addEventListener('click', () => {
            menu.classList.remove('open');
            btn.setAttribute('aria-expanded', 'false');
            menu.setAttribute('aria-hidden', 'true');
        });
    });

    // ---------- 14. INITIALISATION ----------
    window.addEventListener('load', () => {
        genererPrestations();
        if (!localStorage.getItem('dsbat-devis-compteur')) {
            localStorage.setItem('dsbat-devis-compteur', '1000');
        }
        document.getElementById('devisNumero').innerText = genererNumeroDevis();
        afficherDate();
        calculer();
    });
</script>
</body>
</html>